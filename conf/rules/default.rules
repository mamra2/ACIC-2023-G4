// Initialize bot (on Telegram)
val telegramBot = getActions("telegram","telegram:telegramBot:telegrambot")

// Device & Wallpug
// TODO: Delete this rule?
rule "Toggle Wallplug"
    when
        Item MyDeviceIsOnline changed
    then
        Wallplug_Hall.sendCommand(MyDeviceIsOnline.state.toString)
end

// Telegram
rule "Receive Message (on Telegram)"
    when 
        //Change this trigger message
        Item Telegram_Message received update "message test" or
        Item Telegram_Message received update "ON" or
        Item Telegram_Message received update "OFF"
    then
        var message = Telegram_Message.state.toString
        //val telegramBot = getActions("telegram","telegram:telegramBot:telegrambot")
        // Send message to colleague
        telegramBot.sendTelegram(5680556583L, "This is a message for you, Henrique!")
        if (message == "ON" || message == "OFF") {
            Test_Switch.sendCommand(message)
            telegramBot.sendTelegram("Switch changed state to " + message)
        }
        else {
            telegramBot.sendTelegram("Switch didn't change state because the message sent was \n\"" + message + "\"")
        }
end
rule "Query (on Telegram)"
    when
        //Change this trigger message
        Item Telegram_Message received update "reply test"
    then
        //val telegramBot = getActions("telegram","telegram:telegramBot:telegrambot")
        telegramBot.sendTelegramQuery("Do you also want to receive a notification through other services?", "Telegram_Reply", "Send e-mail", "Send IFTTT", "No, thanks")
end
rule "Reply (on Telegram)"
    when
        Item Telegram_ReplyId received update "Telegram_Reply"
    then
        //val telegramBot = getActions("telegram","telegram:telegramBot:telegrambot") 
        var message = Telegram_Message.state.toString
        var notificationConfirmation = (
            if (message == "Send e-mail") ("E-mail") 
            else if (message == "Send IFTTT") ("IFTTT")
            else if (message == "No, thanks") ("No"))
        telegramBot.sendTelegramAnswer(Telegram_ReplyId.state.toString, notificationConfirmation + " notification was sent.")
end
rule "Calendar Event Message (on Telegram)"
    when 
        Item Telegram_Message received update "Event started" or
        Item Telegram_Message received update "Event ended"
    then
        telegramBot.sendTelegram(Test_Switch.name + "'s state was set to " + Test_Switch.state.toString + ", as expected.")
        telegramBot.sendTelegram("The message defined in the calendar event's description was \n\"" + Telegram_Message.state.toString + "\"")
end

// Twitter
rule "Send tweet (on Twitter)"
    when
//        Item Test_Switch received update
        Item Telegram_Message received update "Send Tweet"
    then
        val tweetActions = getActions("twitter","twitter:account:account")
        // Send tweet
        val mention = "@openHAB"
        val tweetMessage = "This is a new Tweet sent for a uni project " + "(with " + mention + ")"
        tweetActions.sendTweet(tweetMessage)
        logInfo("Twitter", "Twitter sent with message \"" + tweetMessage + "\"")
end

// Mail
rule "Send e-mail"
    when 
//        Item Test_Switch received update
        Item Telegram_Message received update "Send e-mail"
    then
        var item = Test_Switch
        var itemName = item.name
        var itemState = item.state
        val receiver = "mamra2@iscte-iul.pt"
        var mailSubject = "ACIC | OpenHAB (Laboratório)"
        var mailContent = "Para efeitos de laboratório, envia-se esta mensagem."
        mailContent += "\nItem " + itemName + " has state " + itemState + "."
        val mailActions = getActions("mail","mail:smtp:smtp")
        mailActions.sendMail(receiver, mailSubject, mailContent)
end

// IFTTT
rule "Send IFTTT Notification"
    when
//        Item Test_Switch received update
        Item Telegram_Message received update "Send IFTTT"
    then
        logInfo("LineBlock","\n" 
            + "//======================================================================================================================================================//")
        // Item Values
        var item = Test_Switch
        var itemName = item.name
        var itemState = item.state

        // IFTTT parameters
        var iftttEvent = 'OH_Alarm'
        var iftttKey = 'opv4AxqQo6hB48Td9nep-E_Y4SKpDPUHNLAkO2izXCx'
        var iftttValues = '?value1=' + itemName + '&value2=' + itemState
        var iftttURL = 'https://maker.ifttt.com/trigger/' + iftttEvent + '/with/key/' + iftttKey + iftttValues

        // POST HTTP Request
        sendHttpPostRequest(iftttURL)
        logInfo("IFTTT", "IFTTT Notification => " + "Item {} has state {}.", itemName, itemState)
        logInfo("IFTTT_URL", "IFTTT Notification sent to URL:\nURL = \"{}\"", iftttURL)
end

// Lights
rule "Control Lights (with dimmer switch)"
    when
        Channel "hue:0820:mybridge:dimmer1:dimmer_switch_event" triggered
    then
        val event = receivedEvent
        logInfo("HueDimmerSwitch", "Hue dimmer switch triggered by event {}", event)
        telegramBot.sendTelegram("Hue Dimmer Switch received event " + event)
	    switch(event) {
		    case "1003.0": logInfo("HueDimmerSwitch", "Hue dimmer switch | Button 1 held")
            case "4003.0": {logInfo("HueDimmerSwitch", "Hue dimmer switch | Button 4 held")}
        }
end



// XBee
